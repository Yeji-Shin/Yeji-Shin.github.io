---
layout: post
title: 0. 모니터링 아키텍처
date: 2022-10-15
category: Prometheus and Grafana 
---


### 모니터링 아키텍처 구성요소


![image](https://user-images.githubusercontent.com/61526722/195978053-b0757fe6-0890-4259-9cdd-5e74c466d06a.png)

- Prometheus
  - 타겟이 되는 서버로 부터 메트릭 수집
  - 특정 규칙에 걸리는 메트릭 정보를 알람매니저에게 알려줌
- Grafana
  - Fromql을 통해 데이터소소인 prometheus에 쿼리를 날리고 받은 결과값으로 데이터 시각화
- Alertmanager
  - Prometheus 로 부터 규칙에 해당되는 메트릭 정보를 받아 해당 정보를 알고 있어야 하는 서비스팀이나 엔지니어에게 메일이나 슬랙 등 여러 매체를 통해 정보를 전달
- Exporter
  - 프로메테우스가 타겟 서버로부터 메트릭을 수집하려면 해당 서버 내부에서 정보를 수집하고 특정 포트를 오픈해야 함 
  - 프로메테우스가 특정 서버로부터 데이터를 가지고 가도록 도와주는 에이전트 역할을 하는 어플리케이션
- Pushgateway PUSH
  - 프로메테우스는 기본적으로 pull 방식으로 타겟 서버로 부터 메트릭을 받음
  - 사용자의 필요에 따라 push 방식을 사용할 때 push gateway 로부터 데이터를 push 받고 프로메테우스는 push gateway로부터 데이터를 가져옴

---

### 모니터링 아키텍처


![image](https://user-images.githubusercontent.com/61526722/195978381-1f188064-b57e-4172-a1db-17e47f2393d9.png)

프로메테우스는 서비스 디스커버리에 존재하는 타겟 서버로 접근해서 데이터를 pull 방식으로 가져온다. 프로메테우스는 서비스 환경에 따라서 k8s나 ec2 등 다양한 서비스 디스커버리를 제공하는데, 파일을 이용할 수도 있다. 프로메테우스가 타겟 서버에 접근할 때는 HTTP 프로토콜을 이용한다. 이때 타겟이 되는 서버는 해당 서버의 시스템이나 어플리케이션에 대한 메트릭을 수집하고 수집당하기 위해서 listen 상태의 포트를 열어놓는 exporter가 필요하다. exporter의 종류는 node exporter(시스템 메트릭 수집), MySQL exporter(MySQL의 메트릭 수집), Nginx exporter(nginx의 가상 호스트 정보 수집) 등이 있다. 

프로메테우스는 pull 방식으로 메트릭을 수집한다고 했는데, 불가피하게 push 방식으로 메트릭을 수집해야 하는 경우 프로메테우스와 타겟서버 사이에 pushgateway라는 것을 두어, 타겟 서버는 pushgateway로 데이터를 전송하고 프로메테우스는 pushgateway 로부터 데이터를 가져오는 형태로 동작한다. 이렇게 하면 사용자가 느끼기에는 push 방식으로 데이터를 수집하도록 동작시킬 수 있다. 

프로메테우스는 앞서 수집된 데이터에 특정 규칙을 걸어서 해당 규칙에 부합할 때 알람을 발생시킨다. 프로메테우스가 직접 사용자에게 알람을 보내는 것이 아니라 알람 매니저에게 해당 상황의 정보를 보내면 알람 매니저가 적합한 수신자에게 알람 내용을 전송한다. 이메일이나 슬랙이나 웹 서버로 알람을 보낼 수 있는데, 웹 서버를 이용하는 경우에는 알람 매니저가 해당 웹 서버에 POST 방식으로 요청을 보낸다. 

프로메테우스는 자체적으로 메트릭 그래프를 보여줄 수 있지만, 더 나은 시각화를 위해 그라파나를 이용한다. 그라파나는 fromql을 이용해 프로메테우스에 질의를 하고 메트릭 데이터를 응답받는다. 수집한 데이터를 통해 판넬에 데이터를 시각화해준다. 




